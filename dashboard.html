<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pardhu ERP – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --theme:#25d366;
}
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f4f6f8;
}
.header{
  background:var(--theme);
  color:#fff;
  padding:15px;
  text-align:center;
  font-size:20px;
}
.role{
  font-size:14px;
  opacity:0.9;
}
.container{
  padding:15px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:15px;
  margin-bottom:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  cursor:pointer;
}
.card h3{ margin:0; font-size:16px; }
.section-title{ margin:15px 0 10px; font-size:18px; }
.product{
  background:#fff;
  padding:10px;
  margin-bottom:8px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  font-size:14px;
}
.logout{
  margin-top:20px;
  background:#e53935;
  color:#fff;
  padding:14px;
  text-align:center;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ===== AUTH GUARD ===== -->
<script>
const user = localStorage.getItem("user");
const role = localStorage.getItem("role");
const company = (localStorage.getItem("company") || "").toLowerCase();

if(!user || !role){
  window.location.href = "index.html";
}
</script>

<div class="header">
  Pardhu ERP
  <div class="role" id="roleText"></div>
</div>

<div class="container">

  <!-- ===== KPI CARDS ===== -->
  <div class="grid" id="kpiGrid">
    <div class="card"><h3>Today Orders</h3><b id="kpiOrders">0</b></div>
    <div class="card"><h3>Sales (₹)</h3><b id="kpiSales">0</b></div>
    <div class="card"><h3>Paid (₹)</h3><b id="kpiPaid">0</b></div>
    <div class="card"><h3>Balance (₹)</h3><b id="kpiBalance">0</b></div>
  </div>

  <!-- ===== MODULES ===== -->
  <div class="grid">

    <div class="card" data-module="products" onclick="location.href='products.html'"><h3>Products</h3></div>
    <div class="card" data-module="stock" onclick="location.href='stock.html'"><h3>Stock</h3></div>
    <div class="card" data-module="orders" onclick="location.href='orders.html'"><h3>Orders</h3></div>
    <div class="card" data-module="reports" onclick="location.href='reports.html'"><h3>Reports</h3></div>
    <div class="card" data-module="settings" onclick="location.href='settings.html'"><h3>Settings</h3></div>
    <div class="card" data-module="employees" onclick="location.href='employees.html'"><h3>Employees</h3></div>

  </div>

  <!-- ===== LIVE PRODUCTS ===== -->
  <div id="liveProductsBlock" style="display:none">
    <div class="section-title">Products (Live)</div>
    <div id="productList">Loading...</div>
  </div>

  <div class="logout" onclick="logout()">Logout</div>
</div>

<!-- ================= RBAC ================= -->
<script>
const modulesRaw = (localStorage.getItem("modules") || "").toLowerCase();
const allowed = modulesRaw === "all" ? ["all"] : modulesRaw.split(",").map(m=>m.trim());

document.getElementById("roleText").innerText =
  role === "super" ? "Super Admin" :
  role === "admin" ? "Company Admin" : "Staff";

/* Hide disallowed modules (skip KPI cards) */
document.querySelectorAll(".card").forEach(card=>{
  const mod = card.dataset.module;
  if(!mod) return;
  if(allowed.includes("all")) return;
  if(!allowed.includes(mod)) card.style.display="none";
});

/* Live products only admin/super */
if(role==="super" || role==="admin"){
  document.getElementById("liveProductsBlock").style.display="block";
}

function logout(){
  localStorage.clear();
  window.location.href="index.html";
}
</script>

<!-- ================= SETTINGS ================= -->
<script>
const SHEET_ID = "1ZG49Svf_a7sjtxv87Zx_tnk8_ymVurhcCm0YzrgKByo";
fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=settings`)
.then(r=>r.text()).then(t=>{
  const j=JSON.parse(t.substring(t.indexOf('{'),t.lastIndexOf('}')+1));
  j.table.rows.forEach(r=>{
    if(!r.c) return;
    if((r.c[2]?.v||"").toLowerCase()!==company) return;
    const k=(r.c[0]?.v||"").toLowerCase();
    const v=(r.c[1]?.v||"").toLowerCase();
    localStorage.setItem(k,v);
    if(k==="theme_color"){
      document.documentElement.style.setProperty("--theme",v);
    }
  });
});
</script>

<!-- ================= LIVE PRODUCTS ================= -->
<script>
fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=products`)
.then(r=>r.text()).then(t=>{
  const j=JSON.parse(t.substring(t.indexOf('{'),t.lastIndexOf('}')+1));
  let html="";
  j.table.rows.forEach(r=>{
    if(!r.c) return;
    if((r.c[5]?.v||"").toLowerCase()!=="yes") return;
    html+=`<div class="product">
      <b>${r.c[1]?.v}</b><br>
      Price: ₹${r.c[2]?.v}<br>
      Stock: ${r.c[3]?.v}
    </div>`;
  });
  document.getElementById("productList").innerHTML=html||"No products";
});
</script>

<!-- ================= KPI ================= -->
<script>
const today=new Date().toISOString().slice(0,10);
fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=orders`)
.then(r=>r.text()).then(t=>{
  const j=JSON.parse(t.substring(t.indexOf('{'),t.lastIndexOf('}')+1));
  let o=0,s=0,p=0,b=0;
  j.table.rows.forEach(r=>{
    if(!r.c) return;
    let d=r.c[1]?.v;
    if(d instanceof Date) d=d.toISOString().slice(0,10);
    if(d!==today) return;
    if((r.c[3]?.v||"").toLowerCase()!==company) return;
    o++; s+=+r.c[7]?.v||0; p+=+r.c[8]?.v||0; b+=+r.c[9]?.v||0;
  });
  kpiOrders.innerText=o;
  kpiSales.innerText=s;
  kpiPaid.innerText=p;
  kpiBalance.innerText=b;
});
</script>

</body>
</html>
